---
title: "Projet DM"
author: "Rochd"
date: "25 octobre 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Exploration des données

## Chargement des données
Nous allons charger et fusionner les bases de données en gardant uniquement les attributs nécessaires.

Base d'apprentissage :
```{r}
df<-read.csv("train.csv")
df$Date<- as.POSIXct(df$Date ,format = "%Y-%m-%d")
```


Base de tests et des magasins :
```{r}
test<-read.csv("test.csv")
store<-read.csv("store.csv",na.strings = "")
```

### Ajustements des variables:

```{r}
df$DayOfWeek<-factor(df$DayOfWeek)
test$DayOfWeek<-factor(test$DayOfWeek)

df$Open<-factor(df$Open)
test$Open<-factor(test$Open)

df$Promo<-factor(df$Promo)
test$Promo<-factor(test$Promo)

df$SchoolHoliday<-factor(df$SchoolHoliday)
test$SchoolHoliday<-factor(test$SchoolHoliday)

store$Promo2<-factor(store$Promo2)

```



Pour la base contenant les magasins nous allons adapter les attributs "CompetitionOpenSinceMonth" et "CompetitionOpenSinceYear"ansi que "Promo2SinceWeek" et "Promo2SinceYear" pour représenter une date précise sous le format "AAAA-MM-JJ" du calendrier POSIXct. 

```{r}

store$Promo2Since <- as.POSIXct(paste(store$Promo2SinceYear,store$Promo2SinceWeek, 1, sep = "-"),format = "%Y-%U-%u")
store$CompetitionOpenSince<- as.POSIXct(paste(store$CompetitionOpenSinceYear ,store$CompetitionOpenSinceMonth , 1, sep = "-"),format = "%Y-%m-%d")

#Delete redundant features
store$CompetitionOpenSinceMonth<-NULL
store$CompetitionOpenSinceYear<-NULL
store$Promo2SinceWeek<-NULL
store$Promo2SinceYear<-NULL
```

Visualisation des données manquantes :
```{r}
library(Amelia)
missmap(store, main = "Données manquantes/Données observées")
sapply(store,function(x) sum(is.na(x)))

```

Pour les valeurs manquantes en relation avec le fait que le magasin participe à la promotion ou non ne causent aucun problème.
Concernant les 3 valeurs manquantes de l'attribut "CompetitionDistance" on observe :
```{r}
hist(store$CompetitionDistance)
```
La majorité des magasins ont une distance de compétition inférieur à 5000
On choisira donc des valeurs inférieur à 5000 pour ces données manquantes.

```{r}
store$CompetitionDistance[is.na(store$CompetitionDistance)]<-as.integer(runif(3, 0, 5000))
```

Données manquantes de la base des tests :
```{r}
sapply(test,function(x) sum(is.na(x)))
```
Nous allons selectionner les lignes qui correspendent à ces valeurs manquantes :

```{r}
test[is.na(test$Open), ]
```
Ceci correspond uniquement au magasin numéro 622 : 
```{r}
table(test$Open[test$Store == 622])
```

Dans la majorité des cas le magasin est ouvert :
Nous allons donc affecter des "1" aux valeurs manquantes :

```{r}
test[is.na(test)] <- 1
```


## Distribution des ventes
 
La distribution des ventes lorsque le magasin est ouvert 
```{r}
library(ggplot2)
ggplot(df[df$Sales!=0,], aes(Sales))+geom_histogram(bins = 100)
```


#Regression linéaire

##Préparation des données :

```{r}
df$Customers<-NULL
train <-merge(df,store)
test0<-merge(test,store)
#converting "POSIXct" data to a continuou variable in order to fit the model ( seconds since the beginning of January 1, 1970)
train$Date<-unclass(train$Date)
test0$Date<-unclass(test0$Date)

train$Promo2Since<-unclass(train$Promo2Since)
test0$Promo2Since<-unclass(test0$Promo2Since)

train$CompetitionOpenSince<-unclass(train$CompetitionOpenSince)
test0$CompetitionOpenSince<-unclass(test0$CompetitionOpenSince)

#which(mergedData$Date<mergedData$Promo2Since)
#Inferieur=train[which(train$Date<train$Promo2Since & train$Store==213),]
#mean(Inferieur$Sales)
#superieur=train[which(train$Date>=train$Promo2Since & train$Store==213),]
#mean(superieur$Sales)
```

Nous testerons le modèle linéaire suivant :
```{r}
features<-colnames(train)[!(colnames(train) %in% c("Sales","Customers"))]
train$Date<-as.integer(train$Date)
train$Promo2Since<-as.integer(train$Promo2Since)
train$CompetitionOpenSince<-as.integer(train$CompetitionOpenSince)
#function to set missing values to 0
setMissingVal<-function(dataset){
  for (i in 1:ncol(dataset)){
    if (is.factor(dataset[,i])&prod(is.na(dataset[,i]))==0)
      levels(dataset[,i])<-append(levels(dataset[,i]),0)
    dataset[,i][is.na(dataset[,i])] <- 0
    
  }
  return (dataset)
}

train<-setMissingVal(train)
#model<-lm(as.vector(train$Sales)~features] , na.action = na.pass )
model<-lm(Sales~Store+DayOfWeek+Open+Promo+StateHoliday+SchoolHoliday+StoreType+Assortment+CompetitionDistance+Promo2+CompetitionOpenSince ,data = train, na.action = na.pass )
```

#Prédictions :

```{r}
test0$Date<-as.integer(test0$Date)
test0$Promo2Since<-as.integer(test0$Promo2Since)
test0$CompetitionOpenSince<-as.integer(test0$CompetitionOpenSince)
predict(model,test0)
```

